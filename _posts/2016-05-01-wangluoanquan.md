---
layout: post
title:  "从破译者的角度浅析网络安全"
date:   2016-05-01 15:14:54
categories: 课程
tags: 课程 python
---
> 前言：

- 本实验本意是希望大家对网络安全提起足够的重视，请不要恶意使用本实验内容随意盗窃他人账号，如果发生后果，本人概不承担责任！
- 本文作为 陈昕 老师课程 计算机网络 的实验讲解文稿

## 实验内容一：简单的破解校园网关

> **本实验模拟了破译者使用最简单的方法（暴力破解）破解网关的过程。**
>
> **今天我尝试使用最简单的方式，来演示如何简单破解我校网关账户**



> **<u>第一步，分析用何种方式破解</u>**

- 最简单的方式：暴力穷举
- 稍微复杂的方式：获取数据库或者网站的管理员权限
- 比较复杂的方式：使用漏洞破解数据库
- 更复杂的方式：暂时不介绍

> **工具清单：**

- 计算机环境：python2.7,Mac os 10.11
- 抓包工具：Chrome for mac
- 解释器：Pycharm for mac  （可更换为官方IDE）
- 网络环境：校园内网

> <u>**第二步，寻找可以验证尝试密码，即可以登录网关的网站(此处有多种选择)**</u>

- 网络邮局，URL：http://202.205.80.154
- 用chrome打开以上URL，尝试抓包，观察数据：

1. 写入尝试密码，网关账号填入test_userid ,网关密码填入test_password
2. 打开开发者工具，并点击NetWork
3. 点击页面上的“连接”按钮，将我们填写的表单发送
4. 可以看到NetWork监测到了一些网络请求，打开其中第一个“202.205.80.10”
5. 点开右边Headers的标签，可以看到这一次网络请求的头部，拖到最下面'form data'，可以发现我们给服务器发送了以下内容：

- DDDDD : test_userid
- upass : test_password
- 0MKKey : login

（多么任性的变量名......）

6.至此，我们可以确定是这一次Post行为，使得服务器检验了我们的账户和密码来达到登录的效果，但是还不确定，不妨让我们来试一下

> **<u>第三步，尝试登录</u>**

1. 让我们用抓包获得的信息，模拟浏览器进行一次请求吧

```python
#-*- coding:utf-8 -*-
#Author:张云浩 2016.4.29
import urllib
import urllib2
def login_gateway(userid,password):
    # 构造我们post给服务器的数据,这是服务器验证我们身份的依据,以及通过这个判断我们的行为'login'
    data = {
		        "DDDDD":userid,
		        "upass":password,
		        "0MKKey":"login"
		}
    # 构造头文件,实际使用中是不需要的,可能是网站为了兼容性牺牲,也可能纯粹为了偷懒......
    headers = {
		'Host':'202.205.80.10',
		'Origin':'http://202.205.80.154',
		'Referer':'http://202.205.80.154/',
		'User-Agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_3)'
                     ' AppleWebKit/537.36 (KHTML, like Gecko) '
                     'Chrome/49.0.2623.87 Safari/537.36'
		}

    # 将我们post的数据进行合理的编码,使得网站可以辨认
    post_data=urllib.urlencode(data)
    # 从抓包分析到的服务器处理请求的url
    login_url = 'http://202.205.80.10/'
    # 构建一个请求对象,包含上面定义的数据,头文件,服务器地址
    request = urllib2.Request(login_url,post_data,headers)
    # 发送我们的请求给服务器,并将返回的数据作为一个对象保存在response中
    response = urllib2.urlopen(request)
    # 返回服务器回应的内容
    return response.read()
# 向服务器发送登录请求
print login_gateway('test','test').decode('gb2312')
```

- 以上的代码可以向服务器发送一个request请求并返回服务器返回的内容，这个内容可以作为我们检验密码是否正确的依据（有兴趣的同学可以将以上代码中最下方两个'test'替换成正确的密码，即可实现网关的登录）

  - 显然，这样是无法返回正确的内容的(因为我并没有传递给服务器正确的账户密码)，服务器回应的是一个对应错误登录的内容。我们可以将自己正确的网关账号输入上去，可以看到对应正确登录的内容。
  - 快速验证返回内容是否正确的诀窍是：找出正确或者错误回应中，唯一的内容（即另一种回应全文无法找到该信息）

  **Tips : 最近由于校园网频频改版，以上代码可能无法使用，但原理是不变的。**

> **<u>第四步，尝试暴力破解</u>**

- 最简单的方式：使用弱密码遍历，如6个重复数字，顺序数字等（耗时忽略不计）


- 简单的方式：使用for循环，实现简单的任意遍历（每百次约耗时14.85秒，若实现遍历所有6位数字，大约需要42小时）
- 更接近暴力破解的方式：使用python自带的多线程遍历，使用简单的新建线程即可（6位数字全部遍历，大约需要0-30分钟）
- 更聪明的方式：安全风险较大，仅口头介绍

> **让我们梳理一下上面理论上的知识点**

- 常用HTTP协议的请求报文—通常是用户向服务器发送的获取某一页面内容的请求
  - GET方式：请求读取由URL所标识的信息
  - POST方式：给服务器添加信息


- 用户访问一个网站的过程解析：
  - 第一步，用户使用浏览器分析指向的URL（统一资源定位符，可以简单的理解为浏览器显示的网站地址）
  - 第二步, 浏览器向DNS服务器申请域名解析，获取网站IP地址
  - 第三步，浏览器获得从DNS返回的IP地址
  - 第四步，浏览器请求与服务器建立TCP连接（默认端口一般为80）
  - 第五步，浏览器向服务器发出HTTP请求（如上面的POST方式或GET方式）
  - 第六步，服务器返回响应给浏览器，这一般是页面的内容或相应的文件
  - 第七步，TCP连接中断
  - 第八步，浏览器解析返回的信息（一般由html,css,JavaScript等组成）


- 暴力破解的为什么有速度限制？

  ​答：因为每一次验证密码，都要对服务器进行一次‘用户请求’->服务器接收’->'服务器验证’->‘服务器返回信息’->'用户接收回应'的过程，限制因素非常多，甚至有时出现服务器不响应的情况，需要额外的代码去处理这些错误。

## 实验内容二：使用伪装WIFI，抓包截取用户密码

> **本实验模拟了免费WIF如何盗取用户密码的过程。**
>
> **例如，在一个公共场合，建立一个伪装成免费WIFI的无线网络（比如可设置为cau-free-wifi），诱惑用户连接WIFI,在用户连上了以后，用户访问的所有网络数据都可以被截获，极易造成账户密码的泄露。**



> **工具清单：**

- 抓包工具: WireShark for mac 2.0.3
- WIFI共享工具： mac os 自带
- 系统环境： mac os 10.11
- 网络环境：自建wifi或以校园内网为基础的wifi

> **<u>第一步，创建伪装网络wifi</u>**

- 网络来源：校园wifi或已连接上网络的wifi
- 网络伪装ssid：CAU或CAUNET或XXX免费WIFI 等
- 网络共享，开启ssid广播

> **<u>第二步：使用抓包软件，截获用户的数据包</u>**

- 选取抓包端口:wifi的对应端口


- 创建过滤器：是查看http协议中向服务器用post（或get）方式发送的数据
- 查看包含明文的数据：从From data处可获得所有post的数据
- 查看截获的加密数据：如果有简单的Md5加密或base64编码，可破解（如今安全性高的网站或应用已经不能直接看到明文）

**现在我们知道，为什么不能连接免费的wifi了吧？因为我们访问所有链接的过程全都被抓包工具记录下来，很容易造成密码的泄露。**

> **让我们梳理一下上面理论上的知识点**

- 抓包的基本原理：

1. 我们抓到的包是什么？

   答：包(Packet)：在包交换网络里，单个消息被划分为多个数据块，这些数据块称为包，它包含发送者和接收者的地址信息。这些包然后沿着不同的路径在一个或多个网络中传输，并且在目的地重新组合。

   ​	数据包主要由“目的IP地址”、“源IP地址”、“净载数据”等部分构成，包括包头和包体，包头是固定长度，包体的长度不定，各字段长度固定，双方的请求数据包和应答数据包的包头结构是一致的，不同的是包体的定义。 数据包的结构与我们平常写信非常类似，目的IP地址是说明这个数据包是要发给谁的，相当于收信人地址；源IP地址是说明这个数据包是发自哪里的，相当于发信人地址；而净载数据相当于信件的内容。 正是因为数据包具有这样的结构，安装了TCP/IP协议的计算机之间才能相互通信。我们在使用基于TCP/IP协议的网络时，网络中其实传递的就是数据包。

2. 我们为什么能够抓到包？

   答：在一般情况下，网络上所有的机器都可以“听”到通过的流量，但对不属于自己的数据包则不予响应（换句话说，工作站A不会捕获属于工作站B的数据，而是简单地忽略这些数据）。如果某个工作站的网络接口处于混杂模式，那么它就可以捕获网络上所有的数据包和帧。

3. 为什么别人能从包里面截取我们的信息？

   答：因为一般安全性不高的应用和网站（诸如微博，论坛，网关）没有对POST数据进行加密（或者用简单方式加密，如BASE64,MD5），致使数据在数据包中以明文显示，所以能轻易看到这些信息。（编者注：BASE64其实是一种编码方式，不涉及加密）

   ​        即便劫持者没有能力破解账户密码，也可以了解你访问的网站，用户名，浏览历史。这对进一步使用木马或者其他方式破解带来了很多可能。

## 后续

> **安全密码的建议**

- 请大家不要使用 弱密码，纯数字密码

- 密码中尽量不要包含个人信息，包括名字，生日，学校

- 比较安全的密码（举例）：每个网站登录密码相互独立，并且使用随机数生成（伪随机数对于一般用户足矣）

  ​

> **更多的信息**

- 这部分尝试登录内容，仅仅是我编写的【农大网关自动登录】脚本的一小部分内容，想要尝试一下我编写的脚本，可以访问-爱思资源站的分享（已经完成打包测试，使用非常简单，让我们登录网关的过程没有丝毫拖泥带水）：http://is.cau.edu.cn/forum.php?mod=viewthread&tid=201963


- 另外关于本校可用脚本还有【Urp绩点计算系统】和【农大网关流量监测系统】，在爱思PT上都有相应的分享:http://is.cau.edu.cn/forum.php?mod=viewthread&tid=201547

- 想要了解以上项目的最新的改进，可以访问我的GitHub关注这些项目的最新进展:https://github.com/ZYunH

  ​
